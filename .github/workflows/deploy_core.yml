name: Deploy core services

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Permission can be added at job level or workflow level    
permissions:
  id-token: write   # This is required for requesting the JWT
  contents: read    # This is required for actions/checkout

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ vars.ENV_NAME }}

    steps:
      - name: Print current environment
        run: |
          echo "environment: ${{ vars.ENV_NAME }}"
    
      - name: Clone the repository
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ secrets.ASSUME_GITHUB_ACTION_ROLE_ARN }}
          role-session-name: GitHubActionSession
          aws-region: ${{ vars.REGION }}  

      - name: Deploy core services
        uses: aws-actions/aws-cloudformation-github-deploy@v1
        with:
          name: ${{vars.STACK_NAME_PREFIX}}-core
          template: core/core.yml
          parameter-overrides: >-
            TemplateBucketName=${{ vars.ENV_NAME }}-${{ secrets.CF_TEMPLATES_S3_BUCKET_SUBFIX }}, 
            AppDataBucketName=${{ vars.ENV_NAME }}-${{ secrets.APP_DATA_S3_BUCKET_SUBFIX }},
            ECRRepoName=${{ vars.ENV_NAME }}-${{ secrets.ECR_REPO_NAME_SUBFIX }}
          no-fail-on-empty-changeset: "1"
